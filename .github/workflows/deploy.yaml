name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  repository_dispatch:
    types: [submodule_update]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT }}
    
    - name: Create cert directory
      run: mkdir -p cert
    
    - name: Create SSL certificates from secrets
      run: |
        echo "${{ secrets.ORIGIN_CERTIFICATE }}" > cert/origin_certificate.pem
        echo "${{ secrets.PRIVATE_KEY }}" > cert/private_key.pem
    
    - name: Create .env files from secrets
      run: |
        echo "${{ secrets.CATALOG_ENV }}" > skincare-catalog/.env
        echo "${{ secrets.WHATSAPP_ENV }}" > skincare-whatsapp-client/.env
        echo "${{ secrets.DB_ENV }}" > .env
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ".env,skincare-catalog/.env,skincare-whatsapp-client/.env,cert/"
        target: "~/skincare-d/"
        strip_components: 0
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Set project directory
          PROJECT_DIR=~/skincare-d
          
          # Check if directory exists, if not clone the repository
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "Cloning repository for first time..."
            git clone --recurse-submodules https://github.com/wignn/skincare-d.git $PROJECT_DIR
            cd $PROJECT_DIR
          else
            echo "Project directory exists, updating..."
            cd $PROJECT_DIR
            
            # Pull latest changes from main branch
            git pull origin main
            
            # Update submodules to latest commit
            git submodule update --init --recursive --remote --merge
          fi
          
          # Check if user is in docker group, if not add sudo
          if groups | grep -q docker; then
            DOCKER_CMD="docker"
          else
            echo "User not in docker group, using sudo..."
            DOCKER_CMD="sudo docker"
          fi
          
          # Stop all containers
          echo "Stopping containers..."
          $DOCKER_CMD compose down || true
          
          # Rebuild images without cache
          echo "Building images..."
          $DOCKER_CMD compose build --no-cache
          
          # Start containers in detached mode
          echo "Starting containers..."
          $DOCKER_CMD compose up -d
          
          # Wait for containers to be ready
          echo "Waiting for containers to be ready..."
          sleep 20
          
          # Clear Laravel cache
          echo "Clearing Laravel cache..."
          $DOCKER_CMD compose exec -T app php artisan config:clear || true
          $DOCKER_CMD compose exec -T app php artisan cache:clear || true
          $DOCKER_CMD compose exec -T app php artisan view:clear || true
          $DOCKER_CMD compose exec -T app php artisan route:clear || true
          
          # Run migrations (if any)
          echo "Running migrations..."
          $DOCKER_CMD compose exec -T app php artisan migrate || true          
          $DOCKER_CMD compose exec -T app php artisan db:seed || true
          
          # Optimize for production
          echo "Optimizing for production..."
          $DOCKER_CMD compose exec -T app php artisan config:cache || true
          $DOCKER_CMD compose exec -T app php artisan route:cache || true
          $DOCKER_CMD compose exec -T app php artisan view:cache || true

          echo "Deployment completed successfully!"